# Mirror Azure DevOps â†’ GitHub
# Pushing on main or develop only
trigger:
  branches:
    include:
      - main
      - develop

pool:
  name: Default
  # vmImage: ubuntu-latest

steps:
  # 1) Complete Checkout with Historic
  - checkout: self
    fetchDepth: 0
    persistCredentials: true

  # 2) Git bot identity config
  - script: |
      git config user.name "ado-mirror-bot"
      git config user.email "ado-mirror-bot@users.noreply.github.com"
    displayName: "Configurar identidad Git"

  # 3) Mirror execution
  - script: |
      set -e

      echo "===> URL origen (ADO)"
      SRC_URL=$(git config --get remote.origin.url)
      echo "$SRC_URL"

      echo "===> Destination URL(GitHub)"
      GH_URL="https://$(GITHUB_PAT)@github.com/$(USUARIO_GITHUB)/$(REPO_GITHUB).git"
      echo "$GH_URL"

      echo "===> Cloning mirror repo..."
      mkdir -p mirror_tmp
      cd mirror_tmp
      git clone --mirror "$SRC_URL"
      cd *.git

      echo "===> Pushing mirror to GitHub..."
      git push --mirror "$GH_URL"
    displayName: "Mirror to GitHub complete"
