# Mirror Azure DevOps â†’ GitHub
# Runs only on main or dev branches
trigger:
  branches:
    include:
      - main

pool:
  name: Default

steps:
  # 1) Full checkout with history
  - checkout: self
    fetchDepth: 0
    persistCredentials: true

  # 2) Configure Git identity
  - powershell: |
      git config user.name "ado-mirror-bot"
      git config user.email "ado-mirror-bot@users.noreply.github.com"
    displayName: "Configure Git identity"

  # 3) Perform the mirroring
  - task: PowerShell@2
    displayName: "Mirror to GitHub complete"
    env:
      GITHUB_PAT: $(GITHUB_PAT)
      USUARIO_GITHUB: $(USUARIO_GITHUB)
      REPO_GITHUB: $(REPO_GITHUB)
    inputs:
      targetType: inline
      script: |
        Write-Host "===> Getting source URL (Azure DevOps)"
        $src = "$(Build.Repository.Uri)"
        Write-Host "Source: $src"

        Write-Host "===> Cloning in mirror mode..."
        git clone --mirror $src repo_mirror
        Set-Location repo_mirror

        Write-Host "===> Building destination URL (GitHub)"
        $ghUrl = "https://$env:GITHUB_PAT@github.com/$env:USUARIO_GITHUB/$env:REPO_GITHUB.git"
        Write-Host "Destination: $ghUrl"

        Write-Host "===> Pushing to GitHub..."
        git push --mirror $ghUrl
