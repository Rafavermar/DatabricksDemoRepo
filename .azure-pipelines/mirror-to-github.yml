# Mirror Azure DevOps â†’ GitHub 
# Pushing on main or develop only
trigger:
  branches:
    include:
      - main
      - develop

pool:
  name: Default

steps:
  # 1) Complete Checkout with Historic
  - checkout: self
    fetchDepth: 0
    persistCredentials: true

  # 2) Git bot identity config
  - script: |
      git config user.name "ado-mirror-bot"
      git config user.email "ado-mirror-bot@users.noreply.github.com"
    displayName: "Configurar identidad Git"
    shell: cmd

  # 3) Mirror execution
  - script: |
      echo ===> URL origen (ADO)
      for /f "delims=" %%i in ('git config --get remote.origin.url') do set SRC_URL=%%i
      echo %SRC_URL%

      echo ===> Destination URL (GitHub)
      set GH_URL=https://%GITHUB_PAT%@github.com/%USUARIO_GITHUB%/%REPO_GITHUB%.git
      echo %GH_URL%

      echo ===> Cloning mirror repo...
      mkdir mirror_tmp
      cd mirror_tmp
      git clone --mirror %SRC_URL%
      cd *.git

      echo ===> Pushing mirror to GitHub...
      git push --mirror %GH_URL%
    displayName: "Mirror to GitHub complete"
    shell: cmd
